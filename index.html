<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="./Genome.js"></script>
    <script src="./Dot.js"></script>
    <script src="./Brain.js"></script>
</head>

<body>
    <style>
        #status {
            position: absolute;
            left: 650px;
            height: 600px;
            width: 600px;
            border: 1px solid black;
        }
    </style>
    <script>
        let dots = []
        let mapp = []
        let pv = 0
        let frame = 0
        const INOUT = 16
        const HIDDEN = 3
        const DOTS = 100
        const GRID = 100
        const PLANTS = 100
        const SPECIES = false
        board()

        function setup() {
            createCanvas(1250, 1000)
            for (let i = 0; i < DOTS; i++) {
                dots[i] = new Dot(INOUT, Math.floor(Math.random() * GRID), Math.floor(Math.random() * GRID), HIDDEN, 0)
                mapp[dots[i].pos.y][dots[i].pos.x] = 1
            }
            frameRate(15)
        }

        let bigman = 0
        let indexbig = 0
        let pbs = 0
        let bs = 0
        let pspe = "r"
        let spe = ""
        function draw() {
            background(255)
            noStroke()
            fill(225)
            rect(0, 0, 600, 600)
            let dts = 0
            let p = 0
            for (let i = 0; i < GRID; i++) {
                for (let j = 0; j < GRID; j++) {
                    if (mapp[i][j] >= 2) {
                        p++
                        let co = mapp[i][j] - 2
                        fill((18 * co), 100 + (18 * co), (18 * co))
                        rect(j * ((100 / GRID) * 6), i * ((100 / GRID) * 6), ((100 / GRID) * 6), ((100 / GRID) * 6))
                        if (co > 0) {
                            mapp[i][j]--
                        }
                    }
                }
            }
            let scores = []
            let dscores = []
            let species = []
            let exdot = []
            let newdots = []
            for (let i = 0; i < dots.length; i++) {
                if (species.includes(dots[i].genome.s)) {
                    scores[species.indexOf(dots[i].genome.s)] += dots[i].score()
                } else {
                    species.push(dots[i].genome.s)
                    scores.push(dots[i].score())
                    exdot.push(i)
                }
                dscores.push(dots[i].score())
                if (!dots[i].dead) {
                    dts++
                    dots[i].update(mapp)
                    let a = dots[i].action()
                    let d = dots[i].moved
                    dots[i].draw(GRID)
                    if (d != 4) {
                        mapp[dots[i].pos.y][dots[i].pos.x] = 0
                        m = checkmove(mapp, dots[i].pos.x, dots[i].pos.y, d)
                        mapp[m[1]][m[0]] = 1
                        dots[i].pos.x = m[0]
                        dots[i].pos.y = m[1]
                        dots[i].dir = dots[i].moved
                    }
                    switch (a) {
                        case 0:
                            break;
                        case 1: // plant
                            m = checkmove(mapp, dots[i].pos.x, dots[i].pos.y, dots[i].dir)
                            if (m[0] != dots[i].pos.x || m[1] != dots[i].pos.y) {
                                mapp[m[1]][m[0]] = 10
                            }
                            break;

                        case 2: // spawn
                            m = checkmove(mapp, dots[i].pos.x, dots[i].pos.y, dots[i].dir)
                            if (m[0] != dots[i].pos.x || m[1] != dots[i].pos.y) {
                                mapp[m[1]][m[0]] = 10
                                newdots.push(dots[i].spawn(m[0], m[1]))
                                mapp[m[1]][m[0]] = 1
                            }
                            break;

                        case 3: // eat
                            m = checkspace(mapp, dots[i].pos.x, dots[i].pos.y, dots[i].dir)
                            if (m[2] == 2) {
                                mapp[m[1]][m[0]] = 0
                            }
                            break;
                    }
                }
            }
            dots.push(...newdots)
            if (dts == 0) {
                reset()
            } else {
                if (SPECIES) {
                    pspe = spe
                    bs = Math.max(...scores)
                    bigman = scores.indexOf(bs)
                    spe = species[bigman].substring(0, 17)
                    if (pspe != spe) {
                        indexbig = exdot[bigman]
                        dots[indexbig].showbrain()
                    }
                    // console.log(dots[bigman].genome.decode())
    
                    frame++
                    fill(0)
                    textSize(28)
                    text(`Showing brain of best species:`, 650, 633)
                    text(spe, 650, 666)
                    text(`Color of Species:`, 650, 700)
                    text(`Species combined score: ${bs.toFixed(3)}`, 650, 733)
                    // console.log(dots[pv].r, dots[pv].g, dots[pv].b)
                    fill(dots[indexbig].r, dots[indexbig].g, dots[indexbig].b)
                    rect(865, 679, 25, 25)
                } else {
                    pspe = spe
                    pbs = bs
                    bs = Math.max(...dscores)
                    bigman = dscores.indexOf(bs)
                    spe = dots[bigman].genome.s.substring(0, 17)
                    if (pspe != spe) {
                        dots[bigman].showbrain()
                    }
                    // console.log(dots[bigman].genome.decode())
    
                    frame++
                    fill(0)
                    textSize(28)
                    text(`Showing brain of best dot:`, 650, 633)
                    text(spe, 650, 666)
                    text(`Color of dot:`, 650, 700)
                    text(`Dot score: ${bs.toFixed(3)}`, 650, 733)
                    text(`Dead? ${dots[bigman].dead ? "Yes" : "No"}`, 650, 766)
                    // console.log(dots[pv].r, dots[pv].g, dots[pv].b)
                    fill(dots[bigman].r, dots[bigman].g, dots[bigman].b)
                    rect(810, 679, 25, 25)
                }
                fill(0)
                text(`Frame: ${frame}`, 10, 633)
                text(`Dots alive: ${dts}`, 10, 666)
                text(`Plants alive: ${p}`, 10, 700)
            }
        }

        function reset() {
            board()
            frame = 0
            dots = []
            for (let i = 0; i < DOTS; i++) {
                dots[i] = new Dot(INOUT, Math.floor(Math.random() * GRID), Math.floor(Math.random() * GRID), HIDDEN, 0)
                mapp[dots[i].pos.y][dots[i].pos.x] = 1
            }
        }

        function board() {
            for (let i = 0; i < GRID; i++) {
                mapp[i] = []
                for (let j = 0; j < GRID; j++) {
                    mapp[i].push(0)
                }
            }
            for (let i = 0; i < PLANTS; i++) {
                mapp[Math.floor(Math.random() * GRID)][Math.floor(Math.random() * GRID)] = 10
            }
        }

        function checkmove(m, x, y, dir) {
            //   3
            //  2+0
            //   1
            switch (dir) {
                case 0:
                    if (x != mapp.length - 1 && mapp[y][x + 1] == 0) {
                        x += 1
                    }
                    break;
                case 1:
                    if (y != mapp.length - 1 && mapp[y + 1][x] == 0) {
                        y += 1
                    }
                    break;
                case 2:
                    if (x != 0 && mapp[y][x - 1] == 0) {
                        x -= 1
                    }
                    break;
                case 3:
                    if (y != 0 && mapp[y - 1][x] == 0) {
                        y -= 1
                    }
                    break;
                case 4:
                    break;
            }
            return [x, y]
        }

        function checkspace(m, x, y, dir) {
            //   3
            //  2+0
            //   1
            switch (dir) {
                case 0:
                    if (x != mapp.length - 1) {
                        x += 1
                    }
                    break;
                case 1:
                    if (y != mapp.length - 1) {
                        y += 1
                    }
                    break;
                case 2:
                    if (x != 0) {
                        x -= 1
                    }
                    break;
                case 3:
                    if (y != 0) {
                        y -= 1
                    }
                    break;
                case 4:
                    break;
            }
            return [x, y, mapp[y][x]]
        }
    </script>
    <div id="status"></div>
</body>

</html>